{
    # Global options
    email admin@sweetsweep.online
    admin 0.0.0.0:2019
    metrics
}

# Main domain configuration
chat.sweetsweep.online {
    # Reverse proxy to Open WebUI
    reverse_proxy open-webui:8080 {
        # Health check
        health_uri /health
        health_interval 30s
        health_timeout 10s
        
        # Load balancing for high concurrency
        lb_policy least_conn
        
        # Timeouts for long-running LLM requests
        transport http {
            read_timeout 5m
            write_timeout 5m
            dial_timeout 30s
        }
        
        # Headers
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # Security headers
    header {
        # Enable HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        # Prevent MIME sniffing
        X-Content-Type-Options "nosniff"
        # XSS Protection
        X-XSS-Protection "1; mode=block"
        # Referrer Policy
        Referrer-Policy "strict-origin-when-cross-origin"
        # Remove server header
        -Server
    }
    
    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 10
        }
        format json
        level INFO
    }
    
    # Enable compression
    encode gzip zstd
    
    # TLS configuration
    tls {
        protocols tls1.2 tls1.3
        ciphers TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256 TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
    }
}

# Monitoring dashboards (Grafana)
monitoring.sweetsweep.online {
    reverse_proxy grafana:3000 {
        health_uri /api/health
        health_interval 30s
        health_timeout 10s

        transport http {
            read_timeout 3m
            write_timeout 3m
            dial_timeout 10s
        }
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    log {
        output file /var/log/caddy/monitoring-access.log {
            roll_size 50mb
            roll_keep 10
        }
        format json
        level INFO
    }

    encode gzip zstd

    tls {
        protocols tls1.2 tls1.3
    }
}
